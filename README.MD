# 这是一个工业设备的监测和学习程序

## 这里有三个端 上位机电脑 单片机中间件 下位机传感器（设备） 
  
## 一共实现两大功能：
* 两个底层核心是分别实现了简易数据库的写入读取、增删改查、语义解析。
还有通过windows的api实现串口通信的开启与收发。
* 一个功能能够在上位机通过指令对下位机进行请求，获取
传感器的响应内容和其对应的响应协议格式。并将其记录存储在上位机系统中。

* 另一个功能能够将已存储完成的响应内容和其对应的协议格式重新载入到单片机中间件中，
并由中间件仿真下位机传感器（设备）与上位机连接，对上位机系统的收发程序进行检测。

* 上位机和中间件件有一套自定的通信协议进行数据包的发送接收。

## 具体功能细节:

### 上位机
* 上位机实现串口底层收发，及其封装。
* 实现了一套预指令供用户进行相关的控制。
* 存储下位机设备的通信协议及其内容。

### 单片机中间件
* 转发上位机下位机间的请求和响应。
* 预指令系统。
* 接收上位机数据并仿真下位机传感器。

## 遇到的问题
* 1 无法从缓冲区正确获取数据。
解决办法:添加同步通信进行调试判断，设置延时。处理调试看到的
error=87（同步） error = 997  error=1460/997（异步）
现在解决了同步问题，异步还是无法直接获取，需要添加GetOverlappedResult函数。
* 2 保持串口接收的同时执行其他命令
解决办法：上多线程
* 3 收发数据字节问题
存储应该使用uint8_t这样的，而不是直接int四字节，在发送数据如果只有一个字节则会多发三个00 00 00

## 说明
### 命令

* 查询现有的所有数据库

QUERY ALL
* 查询某个库中的所有信息(库不用加后缀)

 QUERY {DBNAME}
* 查询某个库中某个id的信息(ID=三个不能分开)

 QUERY {DBNAME} WHERE ID={NUM}
* 开启存储数据到某个库中功能(里头不能出现英文的逗号)

 SAVEDATA TO {DBNAME}
* 删除某个库中的某个id所在行

 DELETE {DBNAME} WHERE ID={NUM}
* 开启串口通信

 OPEN SP
* 开启接收通道

 OPEN RC
* 发送数据库的具体功能码到串口通信

 SEND REQ FROM {DBNAME} WHERE ID={NUM}
* 将接收到的数据存入数据库

 -----暂未实现-----
* 将请求功能码和响应码都发送到串口通信

 SEND REQ&RES FROM {DBNAME} WHERE ID={NUM}


### 数据包格式
* 这里只支持发送1字节的命令
* 报文头格式:包头标识0x24 功能码0x01是发送请求 0x02是将请求和响应都载入单片机 总长度 数据 结束0xEF
* 0x24 0x01 0x10 0x01 0x03 0x00 0x00 0x00 0x02 0xC4 0X0B 0xFE
* 当使用0x02功能时 请求和响应间会有一个0x99分隔符

## 不足
* 串口接收的error = 997  error=1460/997（异步）没有完全解决
* 收发只支持1字节，因为定义和设置问题并没有完善
* 直接将数据存入文件和删除数据库和查询数据库某一行信息功能没做
* 代码混乱致歉
* 因为命令的判定算法，所以ID=必须连续才能正常识别id
* 读取库中功能码的算法没有设计好，所以在存入数据时不能存在英文的逗号','